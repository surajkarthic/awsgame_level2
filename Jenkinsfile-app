pipeline {
    agent any

    environment {
        AWS_REGION = "ap-south-1"
        ECR_REPO_NAME = "my-app-repo"
        // We will define the full image name later
        IMAGE_NAME = "" 
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Build and Push Docker Image') {
            steps {
                // Use a script block to manage variables and shell commands together
                script {
                    // Get the AWS Account ID dynamically
                    def awsAccountId = sh(script: 'aws sts get-caller-identity --query Account --output text', returnStdout: true).trim()

                    // Construct the full image name with the account ID
                    env.IMAGE_NAME = "${awsAccountId}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO_NAME}:${BUILD_NUMBER}"

                    sh '''
                        echo "Building the Docker image with tag: ${IMAGE_NAME}"
                        docker build -t ${IMAGE_NAME} .

                        echo "Logging into Amazon ECR..."
                        aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${awsAccountId}.dkr.ecr.${AWS_REGION}.amazonaws.com

                        echo "Pushing image to ECR..."
                        docker push ${IMAGE_NAME}

                        echo "Image push complete!"
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "CI pipeline completed successfully for image: ${IMAGE_NAME}"
        }
        failure {
            echo "CI pipeline failed."
        }
    }
}
