pipeline {
    agent any

    environment {
        AWS_REGION = "ap-south-1"
        ECR_REPO_NAME = "my-app-repo"
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Build and Push Docker Image') {
            steps {
                script {
                    // Get the AWS Account ID and store it in a Groovy variable
                    def awsAccountId = sh(script: 'aws sts get-caller-identity --query Account --output text', returnStdout: true).trim()

                    // Construct the full ECR image URI and store it in a Groovy variable
                    def imageName = "${awsAccountId}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO_NAME}:${BUILD_NUMBER}"

                    // Use the Groovy variable directly in the shell commands
                    sh "echo 'Building the Docker image with tag: ${imageName}'"
                    sh "docker build -t '${imageName}' ."

                    sh "echo 'Logging into Amazon ECR...'"
                    sh "aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${awsAccountId}.dkr.ecr.${AWS_REGION}.amazonaws.com"

                    sh "echo 'Pushing image to ECR...'"
                    sh "docker push '${imageName}'"

                    sh "echo 'Image push complete!'"
                }
            }
        }
    }

    post {
        success {
            echo "CI pipeline completed successfully!"
        }
        failure {
            echo "CI pipeline failed."
        }
    }
}
